var app = getApp()
var domain = app.globalData.host;
Page({  
  data:{
    information: app.globalData.information,
    arrayeducation: ['文盲', '小学','初中','高中','大学','研究生以上'], 
    value:[]
  },
  onLoad: function (option) {
    console.log('onLoad1')
  },
  inputName: function (e) {
    console.log('输入内容为', e.detail.value)
    app.globalData.Name = e.detail.value
    this.setData({
      name: e.detail.value
    })
  },
  inputWX: function (e) {
    console.log('输入内容为', e.detail.value)
    app.globalData.WX = e.detail.value
    this.setData({
      wx: e.detail.value
    })
  },

  inputNickName: function (e) {
    console.log('输入内容为', e.detail.value)
    app.globalData.NickName = e.detail.value
    this.setData({
      nickname: e.detail.value
    })
  },
  bindPickerSex: function (e) {
    console.log('picker发送选择改变，携带值为', e.detail.value)
    app.globalData.Sex = e.detail.value
    this.setData({
      sex: e.detail.value
    })
  },

  bindPickerBirthday: function(e) {
    console.log('picker发送选择改变，携带值为', e.detail.value)
    app.globalData.Birthday = e.detail.value
    this.setData({
      birthday: e.detail.value
    })
  },
  inputHeight: function (e) {
    console.log('输入内容为', e.detail.value)
    app.globalData.Height = e.detail.value
    this.setData({
      height: e.detail.value
    })
  },

  inputWeight: function (e) {
    console.log('输入内容为', e.detail.value)
    app.globalData.Weight = e.detail.value
    this.setData({
      weight: e.detail.value
    })
  },

  bindPickerIncidenceTime: function (e) {
    console.log('picker发送选择改变，携带值为', e.detail.value)
    app.globalData.IncidenceTime = e.detail.value
    this.setData({
      incidencetime: e.detail.value
    })
  },

  bindPickerEducation: function(e){
    console.log('picker发送选择改变，携带值为', e.detail.value)
    app.globalData.Education = e.detail.value
    this.setData({
      education: e.detail.value
    })
  },
 
  formSubmit: function () {
    
    var warn = '';//弹框时提示的内容
    var flag ='1';//判断信息输入是否完整
    if (this.data.name == ''){
      warn = '请填写正确的姓名！'
    } else if (this.data.sex==''){
      warn = '请填写正确的性别！'
    } else if (this.data.birthday==''){
      warn = '请填写正确的生日信息！'
    } else if (this.data.incidencetime == '') {
      warn = '请填写正确的发病时间！'
    } else if (this.data.height == '') {
      warn = '请填写正确的身高！'
    } else if (this.data.weight == '') {
      warn = '请填写正确的体重！'
    } else if (this.data.education == ''){
      warn = '请填写正确的教育程度！'
    }else{
      flag = '2'
      try{
        const data = JSON.stringify({
          wx: this.data.wx,
          name: this.data.name,
          sex: this.data.sex,
          birthday: this.data.birthday,
          height: this.data.height,
          weight: this.data.weight,
          incidenceTime: this.data.incidencetime,
          education: this.data.education,
   
        })
        var unionid = app.globalData.unionid;
        console.log(data)
        wx.request({
          url: domain+`/wxs/information/form?unionid=${unionid}`,
          data:data,
          method: 'POST',
          contentType: 'application/json;charset=UTF-8',
          header: {
            'content-type': 'application/json'
          },
          success: function (result) {
            
            if (result.errcode != 0) {
              wx.showToast({
                title: '保存成功',
                icon: 'success',
                duration: 2000,
                success:function(){
                  wx.navigateBack({
                    delta: 1
                  })
                }
              })
              console.log(result);
            } else {
              wx.showModal({
                title: '保存失败',
                content: result.errmsg,
                showCancel: false,
                success(res) {
                  if (res.confirm) {
                    console.log('用户点击确定')
                  }
                }
              })
            }
          }
        })
        wx.setStorageSync('WX', this.data.wx)
        // wx.setStorageSync('PhoneNum', this.data.phone)
        // wx.setStorageSync('IDNum', this.data.idnum)
        wx.setStorageSync('Name', this.data.name)
        wx.setStorageSync('NickName', this.data.nickname)
        wx.setStorageSync('Sex', this.data.sex)
        wx.setStorageSync('Birthday', this.data.birthday)
        wx.setStorageSync('Height', this.data.height)
        wx.setStorageSync('Weight', this.data.weight)
        wx.setStorageSync('IncidenceTime', this.data.incidencetime)
        wx.setStorageSync('Education', this.data.education)
      }catch(e){
      }
    }
    // console.log(flag)
    if (flag=='1') {
      wx.showModal({
        title: '提示',
        content: warn
      })
    }else{
      console.log('没有表单错误，允许跳转');
      console.log('abc:' + app.globalData.checkvalue1)
      wx.redirectTo({
        url: '/pages/pages/EvaluationForm4?checkvalue1=' + app.globalData.checkvalue1 + '&time1=' + app.globalData.time1 + '&checkvalue2=' + app.globalData.checkvalue2 + '&time2=' + app.globalData.time2 
      })
    }
  },
  pageload: function () {
    var result = false
    //生成loading框
    wx.showLoading({
      title: '数据请求中',
    })
    this.httprequst();
  },

  httprequst: function () {
    var that = this;
    console.log('发送请求')
    var result = false
    wx.request({
      url: this.data.url,
      method: 'POST',
      data: {
        // 'IDNum': app.globalData.IDNum,//IDNum
        'Name': app.globalData.Name,//Name
        'Page': 1,
      },

      complete: function (res) {
        console.log(res.data)
        try {
          if (res.data.result && res.data.result == 1) {
            // that.data.saPASI5 = res.data.saPASI
            // that.data.PEST = res.data.Arthritis6
            // that.data.PsARisk = res.data.PR7
            that.data.value = res.data.value
            result = true
          }
          that.pagedone(result)
        } catch (e) {
          that.pagedone(result)
        }

      },
    })
  },
  pagedone: function (result) {
    //下面的是操作
    let str = JSON.stringify(this.data.value);
    wx.hideLoading()
    // console.log('result:'+result)
    if (result) {
      if (this.data.value.length > 0){
        console.log('结果返回，跳转到下一个页面');
        wx.navigateTo({
          url: '/pages/pages/EvaluationForm6?value=' + str
        })
      }else{
        wx.showModal({
          title: '提示',
          content: '没有查询到历史记录！'
        })
      }
      
    } else {
      wx.showModal({
        title: '错误',
        content: '获取历史记录失败，请重试'
      })
    }
  },
  formSubmit1: function () {
    var warn = '';//弹框时提示的内容
    var flag = '1';//判断信息输入是否完整
    // console.log(this.data.birthday)
//     else if(!this.checkIDNum(this.data.idnum)) {
//   warn = '请填写正确的身份证号码！'
// }
    // console.log(this.data.incidencetime)
    if (this.data.name == '') {
      warn = '请填写正确的姓名！'
    }  else {
      flag = '2'
      try {
        // wx.setStorageSync('IDNum', this.data.idnum)
        wx.setStorageSync('Name', this.data.name)
      } catch (e) {
      }
    }
    // console.log(flag)
    if (flag == '1') {
      wx.showModal({
        title: '提示',
        content: warn
      })
    } else {
      console.log('没有表单错误，允许发送请求');
      this.pageload()
    }
  }
})
