//index.js
//获取应用实例
const app = getApp()
var server = require('../../utils/server.js');
var WXBizDataCrypt = require('../../utils/WXBizDataCrypt.js');
var domain = "https://tty.tsing-care.com/";
Page({
  data: {
    warnContent: '同意书。',
    userInfo: {},
    hasUserInfo: false,
    unionid:'',
    canIUse: wx.canIUse('button.open-type.getUserInfo'),
    datasList: ['WX', 'IDNum', 'Name', 'NickName', 'Sex', 'Birthday', 'Height', 'Weight', 'IncidenceTime', 'Education', 'PhoneNum', 'checkvalue1', 'time1', 'checkvalue2', 'time2'],
  },
  //事件处理函数
  bindViewTap: function() {
    wx.navigateTo({
      url: '../logs/logs'
    })
  },
  onLoad: function(options) {


    if (app.globalData.userInfo) {
      this.setData({
        userInfo: app.globalData.userInfo,
        hasUserInfo: true,
      })

    } else if (this.data.canIUse) {
      // 由于 getUserInfo 是网络请求，可能会在 Page.onLoad 之后才返回
      // 所以此处加入 callback 以防止这种情况
      app.userInfoReadyCallback = res => {
        this.setData({
          userInfo: res.userInfo,
          hasUserInfo: true
        })
      }
    } else {
      // 在没有 open-type=getUserInfo 版本的兼容处理
      wx.getSetting({
        success: res => {
          if (res.authSetting['scope.userInfo']) {
            // 已经授权，可以直接调用 getUserInfo 获取头像昵称，不会弹框
            //获取用户信息

            wx.getUserInfo({
              success: res => {
                console.log(res);
                // 可以将 res 发送给后台解码出 unionId
                this.globalData.userInfo = res.userInfo;

                wx.login({
                  success: function(date) {
                    if (date.code) {


                      //发起网络请求
                      wx.request({
                        url: domain + '/wxs/rest/sign',
                        data: JSON.stringify({
                          code: date.code,
                          encryptedData: res.encryptedData,
                          iv: res.iv,
                          signature: res.signature,
                          rawData: res.rawData
                        }),
                        method: 'POST',
                        contentType: 'application/json;charset=UTF-8',
                        header: {
                          'content-type': 'application/json'
                        },
                        success: function(result) {
                          console.log(result.data);
                          if (result.errcode != 0) {
                            console.log(result);
                          } else {
                            //sessionKey = result.session_key;
                          }
                        }
                      })
                    } else {
                      console.log('登录失败！' + date.errMsg)
                    }
                  }
                })

                //这个是什么用?	  
                //server.signAndLogin(code, encryptedData, iv, signature, rawData);

                // 由于 getUserInfo 是网络请求，可能会在 Page.onLoad 之后才返回
                // 所以此处加入 callback 以防止这种情况
                if (this.userInfoReadyCallback) {
                  this.userInfoReadyCallback(res)
                }
              }
            })
          }
        }
      })
    }

  },
  getUserInfo: function(e) {
    console.log(e)
    app.globalData.userInfo = e.detail.userInfo
    this.setData({
      userInfo: e.detail.userInfo,
      hasUserInfo: true
    })
  },
  setHc: function(inputKey, value) {
    if (inputKey == 'WX') {
      app.globalData.WX = value
    } else if (inputKey == 'IDNum') {
      app.globalData.IDNum = value
    } else if (inputKey == 'Name') {
      app.globalData.Name = value
    } else if (inputKey == 'NickName') {
      app.globalData.NickName = value
    } else if (inputKey == 'Sex') {
      app.globalData.Sex = value
    } else if (inputKey == 'Birthday') {
      app.globalData.Birthday = value
    } else if (inputKey == 'Height') {
      app.globalData.Height = value
    } else if (inputKey == 'Weight') {
      app.globalData.Weight = value
    } else if (inputKey == 'IncidenceTime') {
      app.globalData.IncidenceTime = value
    } else if (inputKey == 'Education') {
      app.globalData.Education = value
    } else if (inputKey == 'PhoneNum') {
      app.globalData.PhoneNum = value
    } else if (inputKey == 'checkvalue1') {
      app.globalData.checkvalue1 = value
    } else if (inputKey == 'time1') {
      app.globalData.time1 = value
    } else if (inputKey == 'checkvalue2') {
      app.globalData.checkvalue2 = value
    } else if (inputKey == 'time2') {
      app.globalData.time2 = value
    }
    // console.log('设置全局变量：' + inputKey + '    ' + value)
  },
  showbutton:function (){
    this.setData ({
      show:true
    })
  },
  getDatas: function(e) {
    
    console.log(e)
    app.globalData.userInfo = e.detail.userInfo
    this.setData({
      userInfo: e.detail.userInfo,
      hasUserInfo: true,
      show: false
    })
    var that = this;
    wx.getSetting({
      success: res => {
        
        if (res.authSetting['scope.userInfo']) {
          
          //获取用户信息
          wx.getUserInfo({
            success: res => {
              console.log(res);
              // 可以将 res 发送给后台解码出 unionId
              var that = this
              app.globalData.userInfo = res.userInfo;
              for (var i = 0; i < that.data.datasList.length; i++) {
                // console.log()
                try {
                  // console.log(that.data.datasList[i])
                  if (wx.getStorageSync(that.data.datasList[i])) {

                    that.setHc(that.data.datasList[i], wx.getStorageSync(that.data.datasList[i]))
                  }
                  //重置全局变量，以防止第二次进入
                  app.globalData.if_6 = ''
                  app.globalData.if_7 = ''
                  app.globalData.PR5 = ''
                } catch (e) {}
              }
              //获取nickname
              if (that.data.userInfo['nickName']) {
                console.log(that.data.userInfo)
                app.globalData.NickName = that.data.userInfo['nickName']
                app.globalData.Sex = (that.data.userInfo['gender'] - 1)
              }
              wx.login({
                success: function(date) {
                  if (date.code) {
                    //发起网络请求
                    wx.request({
                      url: domain + '/wxs/rest/sign',
                      data: JSON.stringify({
                        code: date.code,
                        encryptedData: res.encryptedData,
                        iv: res.iv,
                        signature: res.signature,
                        rawData: res.rawData
                      }),
                      method: 'POST',
                      contentType: 'application/json;charset=UTF-8',
                      header: {
                        'content-type': 'application/json'
                      },
                      success: function(result) {
                        
                        console.log(result);
                        console.log(result.data.if_doctor);
                       
                        console.log(result.data.if_information);
                        //这里需要 if_information==true 的时候才会有返回
                        app.globalData.unionid = result.data.unionid;
                        var test = "您本次为授权自测";
                        app.globalData.test = test;
                        console.log(app.globalData.test)
                        wx.setStorage({
                          key: 'unionid',
                          data: result.data.unionid,
                        })
                        if (result.data.errcode != 0) {
                          //在这里要进行重新授权处理。
                          console.log(result.data.errmsg);
                          wx.showModal({
                            title: '授权失败',
                            content: result.data.errmsg,
                            showCancel:false,
                            success(res) {
                              if (res.confirm) {
                                console.log('用户点击确定')
                              } 
                            }
                          })
                         
                        } else {
                          //sessionKey = result.session_key;
                          wx.showToast({
                            title: '授权成功',
                            icon: 'success',
                            duration: 1000,//这是显示4秒  还是延迟4秒再显示,
                            success: function (res) {
                              if (result.data.if_doctor == true) {

                                wx.redirectTo({
                                  url: '/pages/pages/doctory',
                                })

                              } else {
                                var num = wx.getStorageSync('datas');
                                if(!num){
                                  wx.redirectTo({
                                    //这样的链接是干什么
                                    url: '/pages/pages/personal1'

                                  })

                                }else{
                                 
                                  var unionids = result.data.unionid;
                                  var unionid = {
                                    unionid: unionids
                                  }
                                  var res = {};
                                  for (var key in num) {
                                    res[key] = num[key];
                                  }
                                  for (var key in unionid) {
                                    res[key] = unionid[key];
                                  }
                                  var testData = JSON.stringify(res);
                                  wx.showModal({
                                    title: '提示',
                                    content: ' 检测到您在未授权之前进行了测试,请问是否对之前的测试信息进行提交',
                                    success(res) {
                                      if (res.confirm) {
                                        wx.showToast({
                                          title: '提交成功',
                                          icon: 'success',
                                          duration: 2000,
                                          success: function (res){
                                            wx.request({
                                              url: domain + '/wxs/evaluation/form',
                                              data: testData,
                                              method: 'POST',
                                              contentType: 'application/json;charset=UTF-8',
                                              success: function (data) {
                                                console.log(data);
                                                console.log(data.data.errcode);
                                                if (data.data.errmsg == "提交成功!") {
                                                  console.log(data.data)
                                                  var code = data.data.data.code;
                                                  wx.reLaunch({
                                                    url: '/pages/pages/EvaluationForm3?code=' + code
                                                  })
                                                }
                                              }
                                            })
                                          }
                                        })
                                        
                                      } else if (res.cancel) {
                                        wx.clearStorage()
                                        wx.redirectTo({
                                          //这样的链接是干什么
                                          url: '/pages/pages/personal1'

                                        })
                                      }
                                    }
                                  })
                                  
                                }
                               
                              
                              }
                            }
                          })
                          
                         
                          // 已经授权，可以直接调用 getUserInfo 获取头像昵称，不会弹框
                          // that.setData({
                          //   hids: !that.data.hids
                          // })
                        }
                      }
                    })
                  } else {
                    console.log('登录失败！' + date.errMsg)
                  }
                }
              })

              //这个是什么用?	  
              //server.signAndLogin(code, encryptedData, iv, signature, rawData);

              // 由于 getUserInfo 是网络请求，可能会在 Page.onLoad 之后才返回
              // 所以此处加入 callback 以防止这种情况
              if (this.userInfoReadyCallback) {
                this.userInfoReadyCallback(res)
              }
            }
          })
        } else if (res.authSetting['scope.userInfo'] === false) { // 授权弹窗被拒绝

          wx.clearStorage()
        }
      }
    });
    if (!e.detail.userInfo) {
      wx.showModal({
        title: '提示',
        content: '若不授权微信登录，则无法获取最新测试结果。点击"授权"按钮方便医生返回测试结果',
        showCancel: false,
        confirmText: '授权',
        success: function(res) {

          if (res.confirm) {
            console.log('用户点击确定')
            //插入读取缓存信息，并赋值给全局变量
            
            wx.openSetting({
              success: (res) => {
                wx.getSetting({
                  success: res => {
                    wx.getUserInfo({
                      success: res => {
                        console.log(res);
                        // 可以将 res 发送给后台解码出 unionId
                        var that = this
                        app.globalData.userInfo = res.userInfo;

                        wx.login({
                          success: function(date) {
                            if (date.code) {
                              //发起网络请求
                              wx.request({
                                url: domain + '/wxs/rest/sign',
                                data: JSON.stringify({
                                  code: date.code,
                                  encryptedData: res.encryptedData,
                                  iv: res.iv,
                                  signature: res.signature,
                                  rawData: res.rawData
                                }),
                                method: 'POST',
                                contentType: 'application/json;charset=UTF-8',
                                header: {
                                  'content-type': 'application/json'
                                },
                                success: function(result) {
                       
                                  console.log(result);
                                  console.log(result.data.if_doctor);
                                  // console.log(result.data.if_information);

                                  app.globalData.informationId = result.data.information.id;
                                  app.globalData.unionid = result.data.unionid
                                  wx.setStorage({
                                    key: 'unionid',
                                    data: result.data.unionid,
                                  })
                                  if (result.data.errcode != 0) {
                                    //在这里要进行重新授权处理。
                                    console.log(result);
                                  } else {
                                    //sessionKey = result.session_key;
                                    wx.showToast({
                                      title: '授权成功',
                                      icon: 'success',
                                      duration: 1000,//这是显示4秒  还是延迟4秒再显示,
                                      success: function () {
                                        if (result.data.if_doctor == true) {

                                          wx.redirectTo({
                                            url: '/pages/pages/doctory',
                                          })

                                        } else {


                                          wx.redirectTo({
                                            //这样的链接是干什么
                                            url: '/pages/pages/personal1'

                                          })

                                        }
                                      }
                                    })


                                    // 已经授权，可以直接调用 getUserInfo 获取头像昵称，不会弹框
                                    // that.setData({
                                    //   hids: !that.data.hids
                                    // })
                                  }
                                }
                              })
                            } else {
                              console.log('登录失败！' + date.errMsg)
                            }
                          }
                        })

                      }
                    })
                  }
                })

              }
            })
          }
        }
      })
    }


  },
  cancel:function(){
   this.setData({
     show:false
   })
    wx.switchTab({
      url: '/pages/pages/begin'
    })
  }
})